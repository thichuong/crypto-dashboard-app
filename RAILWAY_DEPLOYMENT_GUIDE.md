# ğŸš€ Railway Deployment Guide - Crypto Dashboard

## ğŸ“‹ TÃ³m táº¯t váº¥n Ä‘á» vÃ  giáº£i phÃ¡p

### âŒ Váº¥n Ä‘á» gá»‘c
```
Migration failed: (psycopg2.OperationalError) could not translate host name "postgres.railway.internal" to address: Name or service not known
```

### âœ… NguyÃªn nhÃ¢n vÃ  giáº£i phÃ¡p
1. **Lá»—i DNS Resolution**: Hostname `postgres.railway.internal` chá»‰ cÃ³ thá»ƒ truy cáº­p tá»« bÃªn trong Railway network
2. **Environment Variables thiáº¿u**: `DATABASE_URL` khÃ´ng Ä‘Æ°á»£c set Ä‘Ãºng cÃ¡ch
3. **Migration script khÃ´ng handle errors**: Script cÅ© khÃ´ng cÃ³ fallback cho local development

## ğŸ”§ Giáº£i phÃ¡p Ä‘Ã£ thá»±c hiá»‡n

### 1. **Improved Migration Script** (`migrate_railway_v2.py`)
- âœ… Kiá»ƒm tra environment trÆ°á»›c khi connect
- âœ… Fallback cho local development (SQLite)
- âœ… Better error handling vÃ  troubleshooting tips
- âœ… Safe logging (khÃ´ng expose credentials)

### 2. **Updated Configuration** (`app/config.py`)
- âœ… Support cáº£ `DATABASE_URL` vÃ  `POSTGRES_URL`
- âœ… Improved SSL settings cho Railway
- âœ… Increased timeout cho Railway connections
- âœ… Debug info an toÃ n

### 3. **Railway Configuration** (`railway.json`)
- âœ… Updated start command Ä‘á»ƒ dÃ¹ng script v2
- âœ… Increased health check timeout
- âœ… Added `FLASK_ENV=production`

### 4. **Health Check Tool** (`railway_health_check.py`)
- âœ… Debug database connections
- âœ… Check environment variables
- âœ… Safe credential display
- âœ… Detailed troubleshooting suggestions

## ğŸš€ Deployment Steps

### BÆ°á»›c 1: Chuáº©n bá»‹ mÃ´i trÆ°á»ng Railway

1. **Login vÃ o Railway**:
```bash
railway login
```

2. **Link project** (náº¿u chÆ°a cÃ³):
```bash
railway link
```

3. **Add PostgreSQL service** trong Railway dashboard:
   - VÃ o Railway dashboard
   - Click "Add Service" â†’ "Database" â†’ "PostgreSQL"
   - Railway sáº½ tá»± Ä‘á»™ng táº¡o `DATABASE_URL`

### BÆ°á»›c 2: Set Environment Variables

Trong Railway dashboard, Ä‘áº£m báº£o cÃ³ cÃ¡c biáº¿n sau:

```bash
# Required
DATABASE_URL=postgresql://...  # Auto-generated by Railway PostgreSQL service
GEMINI_API_KEY=your_gemini_api_key

# Optional but recommended
FLASK_ENV=production
REDIS_URL=redis://...  # If using Redis
SECRET_KEY=your_secret_key
ENABLE_AUTO_REPORT_SCHEDULER=true
AUTO_REPORT_INTERVAL_HOURS=3
```

### BÆ°á»›c 3: Deploy

1. **Commit changes**:
```bash
git add .
git commit -m "Fix Railway deployment with improved migration script"
git push
```

2. **Deploy to Railway**:
```bash
railway up
```

Hoáº·c configure auto-deploy tá»« GitHub trong Railway dashboard.

### BÆ°á»›c 4: Verify Deployment

1. **Check deployment logs**:
```bash
railway logs --follow
```

2. **Test health endpoint**:
```bash
curl https://your-app.railway.app/health
```

## ğŸ” Troubleshooting

### Náº¿u váº«n gáº·p lá»—i migration:

1. **Check environment variables**:
```bash
railway variables
```

2. **Run migration manually trong Railway**:
```bash
railway run python migrate_railway_v2.py
```

3. **Check database connection**:
```bash
railway run python railway_health_check.py
```

### Common Issues:

#### âŒ `DATABASE_URL not set`
```bash
# Solution: Add PostgreSQL service in Railway dashboard
railway add postgresql
```

#### âŒ `SSL connection error`
```bash
# Solution: Check if SSL settings are correct in config.py
# Railway PostgreSQL requires SSL
```

#### âŒ `Timeout errors`
```bash
# Solution: Increased timeouts in railway.json
# Check network connectivity
```

#### âŒ `Permission denied errors`
```bash
# Solution: Check if Railway service has proper permissions
# Restart the service
```

## ğŸ“ Files Ä‘Æ°á»£c cáº­p nháº­t

### New Files:
- `migrate_railway_v2.py` - Improved migration script
- `railway_health_check.py` - Database health checker
- `railway_start_v2.sh` - Improved deployment script
- `RAILWAY_DEPLOYMENT_GUIDE.md` - Documentation nÃ y

### Updated Files:
- `app/config.py` - Better database configuration
- `railway.json` - Updated deployment settings

## âœ… Verification Checklist

- [ ] PostgreSQL service added in Railway dashboard
- [ ] `DATABASE_URL` environment variable set
- [ ] Required API keys configured (`GEMINI_API_KEY`)
- [ ] Health check endpoint responds (`/health`)
- [ ] Migration runs successfully
- [ ] Application starts without errors
- [ ] Database tables created correctly

## ğŸ†˜ Support

Náº¿u váº«n gáº·p váº¥n Ä‘á»:

1. **Run health check locally**:
```bash
python railway_health_check.py
```

2. **Check Railway logs**:
```bash
railway logs --tail 100
```

3. **Test migration locally**:
```bash
python migrate_railway_v2.py
```

4. **Verify database connection**:
```bash
railway connect postgresql
\dt  # List tables
\q   # Quit
```

## ğŸ¯ Next Steps

1. Monitor deployment trong Railway dashboard
2. Set up monitoring/alerting náº¿u cáº§n
3. Configure auto-scaling náº¿u cÃ³ traffic cao
4. Backup database regularly

---

**Note**: LuÃ´n test changes trong local environment trÆ°á»›c khi deploy lÃªn production!
